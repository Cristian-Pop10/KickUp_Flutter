import 'dart:io';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:image_picker/image_picker.dart';
import 'package:kickup/src/modelo/user_model.dart';
import 'package:shared_preferences/shared_preferences.dart';

class PerfilController {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseStorage _storage = FirebaseStorage.instance;
  final ImagePicker _picker = ImagePicker();

  // M√©todo para obtener el usuario actual
  Future<UserModel?> obtenerUsuarioActual() async {
    try {
      print('üîç Obteniendo usuario actual...');
      
      // Obtener el ID del usuario actual
      final userId = _auth.currentUser?.uid;
      print('üë§ Usuario ID desde Auth: $userId');

      if (userId == null) {
        print('‚ö†Ô∏è No hay usuario autenticado en Firebase Auth');
        // Intentar obtener el ID desde SharedPreferences
        final prefs = await SharedPreferences.getInstance();
        final storedUserId = prefs.getString('user_id');
        print('üíæ Usuario ID desde SharedPreferences: $storedUserId');

        if (storedUserId == null || storedUserId.isEmpty) {
          print('‚ùå No se encontr√≥ usuario en SharedPreferences');
          return null;
        }

        // Obtener datos del usuario desde Firestore
        final doc = await _firestore.collection('usuarios').doc(storedUserId).get();
        if (doc.exists) {
          print('‚úÖ Usuario encontrado en Firestore');
          return UserModel.fromJson(doc.data()!);
        }
      } else {
        // Obtener datos del usuario desde Firestore
        final doc = await _firestore.collection('usuarios').doc(userId).get();
        if (doc.exists) {
          print('‚úÖ Usuario encontrado en Firestore');
          return UserModel.fromJson(doc.data()!);
        } else {
          print('‚ö†Ô∏è Usuario no encontrado en Firestore, creando perfil b√°sico');
        }
      }

      // Si no se encuentra el usuario, crear un modelo con datos b√°sicos
      if (userId != null) {
        final user = _auth.currentUser;
        final userModel = UserModel(
          id: userId,
          email: user?.email ?? '',
          nombre: user?.displayName?.split(' ').first ?? '',
          apellidos: user?.displayName?.split(' ').skip(1).join(' ') ?? '',
        );
        print('‚úÖ Creado perfil b√°sico para usuario');
        return userModel;
      }

      print('‚ùå No se pudo obtener informaci√≥n del usuario');
      return null;
    } catch (e) {
      print('‚ùå Error al obtener el usuario: $e');
      return null;
    }
  }

  // M√©todo para actualizar el perfil del usuario
  Future<bool> actualizarPerfil(UserModel usuario) async {
    try {
      print('üìù Actualizando perfil del usuario...');
      
      if (usuario.id == null) {
        print('‚ùå ID de usuario es null');
        return false;
      }

      print('üíæ Guardando en Firestore...');
      // Actualizar datos en Firestore
      await _firestore.collection('usuarios').doc(usuario.id).set(
            usuario.toJson(),
            SetOptions(merge: true),
          ).timeout(const Duration(seconds: 30));

      // Actualizar displayName en Firebase Auth si es necesario
      if (usuario.nombre != null || usuario.apellidos != null) {
        final user = _auth.currentUser;
        if (user != null) {
          final displayName = [
            usuario.nombre ?? '',
            usuario.apellidos ?? '',
          ].where((s) => s.isNotEmpty).join(' ');

          if (displayName.isNotEmpty) {
            print('üë§ Actualizando displayName en Auth...');
            await user.updateDisplayName(displayName);
          }
        }
      }

      print('‚úÖ Perfil actualizado correctamente');
      return true;
    } catch (e) {
      print('‚ùå Error al actualizar el perfil: $e');
      return false;
    }
  }

  // M√©todo para seleccionar imagen de la galer√≠a
  Future<File?> seleccionarImagenGaleria() async {
    try {
      print('üì± Abriendo galer√≠a...');
      final XFile? pickedFile = await _picker.pickImage(
        source: ImageSource.gallery,
        maxWidth: 512,
        maxHeight: 512,
        imageQuality: 70,
      );

      if (pickedFile != null) {
        final file = File(pickedFile.path);
        print('‚úÖ Imagen seleccionada: ${file.path}');
        return file;
      }
      print('‚ö†Ô∏è No se seleccion√≥ ninguna imagen');
      return null;
    } catch (e) {
      print('‚ùå Error al seleccionar imagen de galer√≠a: $e');
      return null;
    }
  }

  // M√©todo para tomar foto con la c√°mara
  Future<File?> tomarFoto() async {
    try {
      print('üì∑ Abriendo c√°mara...');
      final XFile? pickedFile = await _picker.pickImage(
        source: ImageSource.camera,
        maxWidth: 512,
        maxHeight: 512,
        imageQuality: 70,
      );

      if (pickedFile != null) {
        final file = File(pickedFile.path);
        print('‚úÖ Foto tomada: ${file.path}');
        return file;
      }
      print('‚ö†Ô∏è No se tom√≥ ninguna foto');
      return null;
    } catch (e) {
      print('‚ùå Error al tomar foto: $e');
      return null;
    }
  }

  // M√©todo para subir imagen a Firebase Storage
  Future<String?> subirImagen(File imagen, String userId) async {
    try {
      print('=== INICIO SUBIDA DE IMAGEN ===');
      print('üìÅ Ruta de la imagen: ${imagen.path}');
      print('üìã Existe el archivo: ${await imagen.exists()}');
      print('üë§ Usuario autenticado: ${_auth.currentUser?.uid}');
      
      // Verificar tama√±o del archivo
      final fileSize = await imagen.length();
      final fileSizeMB = fileSize / (1024 * 1024);
      print('üìä Tama√±o de la imagen: ${fileSizeMB.toStringAsFixed(2)} MB');
      
      if (fileSizeMB > 5) {
        print('‚ùå Archivo demasiado grande: ${fileSizeMB.toStringAsFixed(2)} MB');
        return null;
      }

      // Crear referencia al archivo en Storage (usando ruta m√°s simple)
      final fileName = '$userId.jpg';
      final storageRef = _storage.ref().child('imagenes').child(fileName);
      print('üìç Referencia Storage: imagenes/$fileName');

      print('üîÑ Iniciando subida...');
      
      // Subir la imagen con timeout
      final UploadTask uploadTask = storageRef.putFile(
        imagen,
        SettableMetadata(contentType: 'image/jpeg'),
      );

      // Monitorear progreso
      uploadTask.snapshotEvents.listen((TaskSnapshot snapshot) {
        final progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        print('üìà Progreso de subida: ${progress.toStringAsFixed(1)}%');
      });

      // Esperar a que se complete la subida con timeout
      final TaskSnapshot snapshot = await uploadTask.timeout(
        const Duration(minutes: 2),
        onTimeout: () {
          print('‚è∞ Timeout en la subida');
          uploadTask.cancel();
          throw Exception('Timeout en la subida de imagen');
        },
      );

      // Obtener la URL de descarga
      final String downloadUrl = await snapshot.ref.getDownloadURL();
      print('‚úÖ Imagen subida exitosamente');
      print('üîó URL de descarga: $downloadUrl');

      return downloadUrl;
    } catch (e) {
      print('‚ùå Error al subir imagen: $e');
      if (e is FirebaseException) {
        print('üî• Tipo de error: FirebaseException');
        print('üî• C√≥digo de error Firebase: ${e.code}');
        print('üî• Mensaje de error Firebase: ${e.message}');
      } else {
        print('‚ö†Ô∏è Tipo de error: ${e.runtimeType}');
      }
      return null;
    }
  }

  // M√©todo para actualizar la foto de perfil
  Future<bool> actualizarFotoPerfil(File imagen, String userId) async {
    try {
      print('=== INICIO ACTUALIZACI√ìN FOTO PERFIL ===');
      print('üë§ Usuario ID: $userId');
      
      // Subir la imagen a Firebase Storage
      final imageUrl = await subirImagen(imagen, userId);

      if (imageUrl == null) {
        print('‚ùå Error: No se pudo obtener URL de la imagen');
        return false;
      }

      print('üíæ Actualizando URL en Firestore...');
      // Actualizar la URL de la imagen en el perfil del usuario
      await _firestore.collection('usuarios').doc(userId).update({
        'profileImageUrl': imageUrl,
      }).timeout(const Duration(seconds: 30));

      // Actualizar photoURL en Firebase Auth
      final user = _auth.currentUser;
      if (user != null) {
        print('üë§ Actualizando photoURL en Auth...');
        await user.updatePhotoURL(imageUrl);
      }

      print('‚úÖ Foto de perfil actualizada correctamente');
      return true;
    } catch (e) {
      print('‚ùå Error al actualizar foto de perfil: $e');
      if (e is FirebaseException) {
        print('üî• C√≥digo de error Firebase: ${e.code}');
        print('üî• Mensaje de error Firebase: ${e.message}');
      }
      return false;
    }
  }

  // M√©todo para eliminar la foto de perfil
  Future<bool> eliminarFotoPerfil(String userId) async {
    try {
      print('üóëÔ∏è Eliminando foto de perfil...');
      
      // Intentar eliminar la imagen de Storage
      try {
        final storageRef = _storage.ref().child('imagenes').child('$userId.jpg');
        await storageRef.delete();
        print('‚úÖ Imagen eliminada de Storage');
      } catch (e) {
        print('‚ö†Ô∏è Error al eliminar imagen de Storage: $e');
        // Continuar aunque falle la eliminaci√≥n de Storage
      }

      // Actualizar el perfil para eliminar la URL de la imagen
      await _firestore.collection('usuarios').doc(userId).update({
        'profileImageUrl': FieldValue.delete(),
      }).timeout(const Duration(seconds: 30));

      // Actualizar photoURL en Firebase Auth
      final user = _auth.currentUser;
      if (user != null) {
        await user.updatePhotoURL(null);
      }

      print('‚úÖ Foto de perfil eliminada correctamente');
      return true;
    } catch (e) {
      print('‚ùå Error al eliminar foto de perfil: $e');
      return false;
    }
  }
}
